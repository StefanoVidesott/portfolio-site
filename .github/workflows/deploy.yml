name: Deploy to Production Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/stefano/portfolio-site

            echo "üì• Scaricando gli ultimi aggiornamenti da GitHub..."
            git pull origin main

            echo "üê≥ Ricreando l'immagine Docker e riavviando il container..."
            docker compose up -d --build

            echo " Ripulendo la cache di cloudflare..."
            curl https://api.cloudflare.com/client/v4/zones/70916b528b23e7d015161a482fddda8a/purge_cache \
              -H 'Content-Type: application/json' \
              -H "Authorization: Bearer ${{ CLOUDFLARE_PURGE_API_TOKEN }}" \
              -d '{
                "hosts": ["www.stefanovidesott.com"],
                "files": [
                  "https://www.stefanovidesott.com/static/css/style.css",
                  "https://www.stefanovidesott.com/static/css/style-min.css",
                  "https://www.stefanovidesott.com/static/js/main.js",
                  "https://www.stefanovidesott.com/static/js/main-min.js"
                ]
              }'

            echo "‚úÖ Deploy completato con successo!"